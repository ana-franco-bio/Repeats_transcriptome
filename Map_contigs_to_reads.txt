#!/bin/sh
#$ -cwd
#$ -j y
#$ -pe smp 1
#$ -l h_rt=10:0:0
#$ -l h_vmem=20G


###input reads

TRANSLIB=CW3

INPUT_R1=SRR3176677_1.fastq.gz
INPUT_R2=SRR3176677_2.fastq.gz

MINlENGTH=101 #minimus length for trimmomatic length filtering

#load the modules
module load samtools
module load bowtie2
module load java

#trimmomatic length filtering
java -jar /data/home/btx671/programs/Trimmomatic-0.39/trimmomatic-0.39.jar PE $INPUT_R1 $INPUT_R2 trimmed${INPUT_R1}_paired.fastq trimmed${INPUT_R1}_unpaired.fastq trimmed${INPUT_R2}_paired.fastq trimmed${INPUT_R2}_upaired.fastq ILLUMINACLIP:/data/home/btx671/programs/Trimmomatic-0.39/adapters/TruSeq3-PE-2.fa:2:30:10:2:keepBothReads LEADING:3 TRAILING:3 MINLEN:$MINlENGTH HEADCROP:0

#create reference
bowtie2-build allrepeats.fasta allrepeats.ref

#bowtie2 map
bowtie2 -q -x allrepeats.ref -1 trimmed${INPUT_R1}_paired.fastq -2 trimmed${INPUT_R2}_paired.fastq|samtools view -bS -> lengthfiltered_allrepeats_${TRANSLIB}_align.bam

#samtools filter out the unmapped reads
samtools view -h -F 4 -b lengthfiltered_allrepeats_${TRANSLIB}_align.bam > mappedlengthfiltered_allrepeats_${TRANSLIB}_align.bam
samtools sort mappedlengthfiltered_allrepeats_${TRANSLIB}_align.bam -o mappedlengthfiltered_allrepeats_${TRANSLIB}_align_sorted.bam
samtools view mappedlengthfiltered_allrepeats_${TRANSLIB}_align_sorted.bam|cut -f1,3 > mappedlengthfiltered_allrepeats_${TRANSLIB}_align_sorted_cut.txt

#Loop the reads number for each cluster
for i in {1..208}
do
  grep "CL${i}Contig" mappedlengthfiltered_allrepeats_${TRANSLIB}_align_sorted_cut.txt | wc -l >> file${TRANSLIB}_${MINLENGTH}.txt
 done

 
 